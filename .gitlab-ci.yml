stages:
  - verify
  - tag
  - build
  - gitops

variables:
  GIT_DEPTH: "0"
  DOCKER_BUILDKIT: "1"
  DOCKER_TLS_CERTDIR: ""

# -------------------------
# 0) VERIFY BUILD for Merge Request (no push, no tag)
# -------------------------
verify_build:
  stage: verify
  image: maven:3.9-eclipse-temurin-21
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
  script:
    - mvn -q -DskipTests package

# -------------------------
# 1) AUTO TAG (only master push)
# -------------------------
auto_tag:
  stage: tag
  image: alpine:3.20
  rules:
    - if: '$CI_COMMIT_BRANCH == "master" && $CI_PIPELINE_SOURCE == "push"'
  before_script:
    - apk add --no-cache git bash
    - git config user.email "routex@orion-hub"
    - git config user.name "routex-bot"
    - git fetch --tags
  script: |
    set -e
    LAST_TAG="$(git tag -l "v*" --sort=-v:refname | head -n 1)"
    if [ -z "$LAST_TAG" ]; then LAST_TAG="v0.0.0"; fi

    VERSION="${LAST_TAG#v}"
    MAJOR="$(echo "$VERSION" | cut -d. -f1)"
    MINOR="$(echo "$VERSION" | cut -d. -f2)"
    PATCH="$(echo "$VERSION" | cut -d. -f3)"

    PATCH="$((PATCH + 1))"
    NEW_TAG="v${MAJOR}.${MINOR}.${PATCH}"
    echo "$NEW_TAG" > tag.txt

    # push tag (Project Access Token -> username is token name, e.g. routex)
    git tag -a "$NEW_TAG" -m "CI release $NEW_TAG"
    git remote set-url origin "https://routex:${GITLAB_PUSH_TOKEN}@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git"
    git push origin "$NEW_TAG"
  artifacts:
    expire_in: 7 days
    paths:
      - tag.txt

# -------------------------
# 2) BUILD & PUSH IMAGE (master only)
# -------------------------
build_push_image:
  stage: build
  image: docker:27
  services:
    - name: docker:27-dind
  needs:
    - job: auto_tag
      artifacts: true
  rules:
    - if: '$CI_COMMIT_BRANCH == "master" && $CI_PIPELINE_SOURCE == "push"'
  before_script:
    - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" --password-stdin "$CI_REGISTRY"
  script: |
    set -e
    TAG="$(cat tag.txt)"
    echo "Build & push image: $CI_REGISTRY_IMAGE:$TAG"

    docker build -t "$CI_REGISTRY_IMAGE:$TAG" .
    docker push "$CI_REGISTRY_IMAGE:$TAG"
  artifacts:
    expire_in: 7 days
    paths:
      - tag.txt

# -------------------------
# 3) UPDATE GITOPS VALUES (master only)
# -------------------------
update_gitops_values_dev:
  stage: gitops
  image: alpine:3.20
  needs:
    - job: build_push_image
      artifacts: true
  rules:
    - if: '$CI_COMMIT_BRANCH == "master" && $CI_PIPELINE_SOURCE == "push"'
  before_script:
    - apk add --no-cache git yq
  script: |
    set -e
    : "${GITOPS_REPO_URL:?GITOPS_REPO_URL is not set}"
    : "${GITOPS_PUSH_TOKEN:?GITOPS_PUSH_TOKEN is not set}"

    TAG="$(cat tag.txt)"
    export TAG

    VALUES_PATH="deployment-config/service/${CI_PROJECT_NAME}/values-dev.yaml"

    git clone "https://routex:${GITOPS_PUSH_TOKEN}@${GITOPS_REPO_URL}" gitops
    cd gitops

    git config user.email "routex@orion-hub"
    git config user.name "routex-bot"

    test -f "$VALUES_PATH"

    yq -i '.image.repository = strenv(CI_REGISTRY_IMAGE)' "$VALUES_PATH"
    yq -i '.image.tag = strenv(TAG)' "$VALUES_PATH"

    git add "$VALUES_PATH"
    git commit -m "chore(gitops): ${CI_PROJECT_NAME} -> ${TAG} (dev)" || echo "No changes"
    git pull --rebase origin master
    git push origin master