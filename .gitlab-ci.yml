stages:
  - test
  - tag
  - build
  - gitops

variables:
  GIT_DEPTH: "0"
  DOCKER_BUILDKIT: "1"
  DOCKER_TLS_CERTDIR: ""   # hay cần cho docker:dind

# ---------- 1) TEST ----------
test:
  stage: test
  image: maven:3.9-eclipse-temurin-21
  rules:
    - if: '$CI_COMMIT_BRANCH'
  script:
    - mvn -q -DskipTests=false test

# ---------- 2) AUTO TAG (master only) ----------
auto_tag:
  stage: tag
  image: alpine:3.20
  rules:
    - if: '$CI_COMMIT_BRANCH == "master"'
  before_script:
    - apk add --no-cache git bash
    - git config user.email "ci-bot@orion-hub"
    - git config user.name "ci-bot"
    - git fetch --tags
  script:
    - |
      set -e

      LAST_TAG="$(git tag -l "v*" --sort=-v:refname | head -n 1)"
      if [ -z "$LAST_TAG" ]; then LAST_TAG="v0.0.0"; fi
      echo "LAST_TAG=$LAST_TAG"

      VERSION="${LAST_TAG#v}"
      MAJOR="$(echo "$VERSION" | cut -d. -f1)"
      MINOR="$(echo "$VERSION" | cut -d. -f2)"
      PATCH="$(echo "$VERSION" | cut -d. -f3)"

      PATCH="$((PATCH + 1))"
      NEW_TAG="v${MAJOR}.${MINOR}.${PATCH}"
      echo "NEW_TAG=$NEW_TAG"

      echo "$NEW_TAG" > tag.txt

      # tạo annotated tag
      git tag -a "$NEW_TAG" -m "CI release $NEW_TAG"

      # push tag bằng token có quyền write_repository
      git remote set-url origin "https://oauth2:${GITLAB_PUSH_TOKEN}@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git"
      git push origin "$NEW_TAG"
  artifacts:
    expire_in: 7 days
    paths:
      - tag.txt

# ---------- 3) BUILD & PUSH IMAGE ----------
build_push_image:
  stage: build
  image: docker:27
  services:
    - name: docker:27-dind
  variables:
    DOCKER_TLS_CERTDIR: ""
  needs:
    - job: auto_tag
      artifacts: true
  rules:
    - if: '$CI_COMMIT_BRANCH == "master"'
  before_script:
    - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" --password-stdin "$CI_REGISTRY"
  script:
    - set -e
    - TAG="$(cat tag.txt)"
    - echo "CI_REGISTRY_IMAGE=$CI_REGISTRY_IMAGE"
    - echo "Build image: $CI_REGISTRY_IMAGE:$TAG"
    - docker build -t "$CI_REGISTRY_IMAGE:$TAG" .
    - docker push "$CI_REGISTRY_IMAGE:$TAG"
    - docker tag "$CI_REGISTRY_IMAGE:$TAG" "$CI_REGISTRY_IMAGE:latest"
    - docker push "$CI_REGISTRY_IMAGE:latest"
  artifacts:
    expire_in: 7 days
    paths:
      - tag.txt

# ---------- 4) UPDATE GITOPS (values-dev.yaml) ----------
update_gitops_values_dev:
  stage: gitops
  image: alpine:3.20
  rules:
    - if: '$CI_COMMIT_BRANCH == "master"'
  needs:
    - job: build_push_image
      artifacts: true
  before_script:
    - apk add --no-cache git yq
    - git config user.email "ci-bot@orion-hub"
    - git config user.name "ci-bot"
  script:
    - set -e
    - TAG="$(cat tag.txt)"
    - export TAG

    - echo "Update GitOps values: tag=$TAG"
    - echo "Image repository (for Helm): $CI_REGISTRY_IMAGE"

    # clone gitops repo
    - git clone "https://oauth2:${GITOPS_PUSH_TOKEN}@${GITOPS_REPO_URL}" gitops
    - cd gitops

    # update values: image.repository & image.tag
    - yq -i '.image.repository = strenv(CI_REGISTRY_IMAGE)' "$GITOPS_VALUES_PATH_DEV"
    - yq -i '.image.tag = strenv(TAG)' "$GITOPS_VALUES_PATH_DEV"

    - git add "$GITOPS_VALUES_PATH_DEV"
    - git commit -m "chore(gitops): ${CI_PROJECT_NAME} -> ${TAG} (dev)" || echo "No changes to commit"
    - git push origin master