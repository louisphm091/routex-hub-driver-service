stages:
  - test
  - tag
  - build
  - gitops

variables:
  GIT_DEPTH: "0"
  DOCKER_BUILDKIT: "1"
  DOCKER_TLS_CERTDIR: ""

# =======================
# 1) TEST - chạy cho feature branch + MR + master
# =======================
test:
  stage: test
  image: maven:3.9-eclipse-temurin-21
  rules:
    # chạy khi có MR
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    # chạy khi push branch (feature/*, master...)
    - if: '$CI_COMMIT_BRANCH'
  script:
    - mvn -q -DskipTests=false test

# =======================
# 2) AUTO TAG - chỉ chạy khi merge vào master
# =======================
auto_tag:
  stage: tag
  image: alpine:3.20
  rules:
    - if: '$CI_COMMIT_BRANCH == "master" && $CI_PIPELINE_SOURCE == "push"'
  before_script:
    - apk add --no-cache git bash
    - git config user.email "ci-bot@orion-hub"
    - git config user.name "ci-bot"
    - git fetch --tags
  script: |
    set -e

    LAST_TAG="$(git tag -l "v*" --sort=-v:refname | head -n 1)"
    if [ -z "$LAST_TAG" ]; then LAST_TAG="v0.0.0"; fi
    echo "LAST_TAG=$LAST_TAG"

    VERSION="${LAST_TAG#v}"
    MAJOR="$(echo "$VERSION" | cut -d. -f1)"
    MINOR="$(echo "$VERSION" | cut -d. -f2)"
    PATCH="$(echo "$VERSION" | cut -d. -f3)"

    PATCH="$((PATCH + 1))"
    NEW_TAG="v${MAJOR}.${MINOR}.${PATCH}"
    echo "NEW_TAG=$NEW_TAG"
    echo "$NEW_TAG" > tag.txt

    git tag -a "$NEW_TAG" -m "CI release $NEW_TAG"
    git remote set-url origin "https://oauth2:${GITLAB_PUSH_TOKEN}@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git"
    git push origin "$NEW_TAG"
  artifacts:
    expire_in: 7 days
    paths:
      - tag.txt

# =======================
# 3a) BUILD for MR (không push, chỉ verify)
# =======================
build_image_mr:
  stage: build
  image: docker:27
  services:
    - name: docker:27-dind
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
  before_script:
    - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" --password-stdin "$CI_REGISTRY"
  script: |
    set -e
    TAG="mr-${CI_MERGE_REQUEST_IID}-${CI_COMMIT_SHORT_SHA}"
    echo "Build image for MR: $CI_REGISTRY_IMAGE:$TAG"
    docker build -t "$CI_REGISTRY_IMAGE:$TAG" .

# =======================
# 3b) BUILD & PUSH for master release
# =======================
build_push_image:
  stage: build
  image: docker:27
  services:
    - name: docker:27-dind
  needs:
    - job: auto_tag
      artifacts: true
  rules:
    - if: '$CI_COMMIT_BRANCH == "master" && $CI_PIPELINE_SOURCE == "push"'
  before_script:
    - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" --password-stdin "$CI_REGISTRY"
  script: |
    set -e
    TAG="$(cat tag.txt)"
    echo "Build & push image: $CI_REGISTRY_IMAGE:$TAG"

    docker build -t "$CI_REGISTRY_IMAGE:$TAG" .
    docker push "$CI_REGISTRY_IMAGE:$TAG"

    docker tag "$CI_REGISTRY_IMAGE:$TAG" "$CI_REGISTRY_IMAGE:latest"
    docker push "$CI_REGISTRY_IMAGE:latest"
  artifacts:
    expire_in: 7 days
    paths:
      - tag.txt

# =======================
# 4) UPDATE GITOPS - chỉ master
# =======================
update_gitops_values_dev:
  stage: gitops
  image: alpine:3.20
  needs:
    - job: build_push_image
      artifacts: true
  rules:
    - if: '$CI_COMMIT_BRANCH == "master" && $CI_PIPELINE_SOURCE == "push"'
  before_script:
    - apk add --no-cache git yq
    - git config user.email "ci-bot@orion-hub"
    - git config user.name "ci-bot"
  script: |
    set -e

    TAG="$(cat tag.txt)"
    export TAG

    echo "Update GitOps: tag=$TAG repo=$CI_REGISTRY_IMAGE"

    git clone "https://oauth2:${GITOPS_PUSH_TOKEN}@${GITOPS_REPO_URL}" gitops
    cd gitops

    yq -i '.image.repository = strenv(CI_REGISTRY_IMAGE)' "$GITOPS_VALUES_PATH_DEV"
    yq -i '.image.tag = strenv(TAG)' "$GITOPS_VALUES_PATH_DEV"

    git add "$GITOPS_VALUES_PATH_DEV"
    git commit -m "chore(gitops): ${CI_PROJECT_NAME} -> ${TAG} (dev)" || echo "No changes"
    git push origin master